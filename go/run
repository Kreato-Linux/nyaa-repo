#!/bin/sh
NAME="go"
RELEASE="1"
VERSION="1.21.1"
SOURCES="https://go.dev/dl/go$VERSION.src.tar.gz"
BUILD_DEPENDS="wget"
DEPENDS="git"
SHA256SUM="bfa36bf75e9a1e9cbbdb9abcf9d1707e479bd3a07880a8ae3564caee5711cb99"
DESCRIPTION="Go is a statically typed, compiled programming language designed at Google"

build() {
    if ! command -v go > /dev/null; then
        echo "go: go not found to bootstrap, downloading binary to bootstrap..."
        # We get the architecture by hand since
        # kpkg doesn't currently offer any variable to do this.
        ARCH=""
        case $(uname -m)
        in
            "x86_64")
                ARCH="amd64"
            ;;
            *)
                ARCH="$(uname -m)"
            ;;
        esac
        wget https://go.dev/dl/go$VERSION.linux-$ARCH.tar.gz
        tar -xvf go$VERSION.linux-$ARCH.tar.gz
        export PATH=$PATH:$PWD/go/bin
    fi
    cd src || exit 1
    export GOENV="/opt/kpkg/srcdir/go/env" 
    export GOCACHE="/opt/kpkg/srcdir/go-build"
    go env -w  GOCACHE="/opt/kpkg/srcdir/go-build"
    ./make.bash
}

package() {
    mkdir -p "$ROOT"/bin
    cp -r ./bin "$ROOT"
    mkdir -p "$ROOT"/usr/local/go
    cp -r . "$ROOT"/usr/local/go
    mkdir -p /opt/kpkg/srcdir/go
}

postinstall() {
    go env -w GOROOT="/usr/local/go" > /dev/null
    exit 0
}
